name: CI

on:
  push:
    branches:
      - main
      - codex/**
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "**/pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"

      - name: Lint
        run: |
          ruff check .
          ruff format --check .

      - name: Test
        run: pytest

  deploy-coolify:
    name: Deploy to Coolify
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Trigger Coolify deploy webhook
        env:
          COOLIFY_WEBHOOK: ${{ secrets.COOLIFY_WEBHOOK }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
          COOLIFY_APP_UUID: ${{ secrets.COOLIFY_APP_UUID }}
          COOLIFY_APP_UUID_VAR: ${{ vars.COOLIFY_APP_UUID }}
          COOLIFY_DEPLOY_REQUIRED: ${{ vars.COOLIFY_DEPLOY_REQUIRED }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          APP_UUID="${COOLIFY_APP_UUID:-${COOLIFY_APP_UUID_VAR}}"
          REQUIRE_DEPLOY="$(echo "${COOLIFY_DEPLOY_REQUIRED:-false}" | tr '[:upper:]' '[:lower:]')"
          if [ -n "${COOLIFY_DEPLOY_REQUIRED}" ] && [ "${REQUIRE_DEPLOY}" != "true" ]; then
            echo "::warning::Unrecognized COOLIFY_DEPLOY_REQUIRED='${COOLIFY_DEPLOY_REQUIRED}'. Only 'true' (case-insensitive) enables strict deploy enforcement."
          fi

          if [ -z "${COOLIFY_WEBHOOK}" ] || [ -z "${COOLIFY_TOKEN}" ] || [ -z "${APP_UUID}" ]; then
            if [ "${REQUIRE_DEPLOY}" = "true" ]; then
              echo "::error::Missing Coolify deploy config. Configure COOLIFY_WEBHOOK + COOLIFY_TOKEN secrets and COOLIFY_APP_UUID (secret or repository variable)."
              exit 1
            fi
            echo "::warning::Skipping Coolify deploy verification because deploy config is incomplete. Set COOLIFY_DEPLOY_REQUIRED=true to enforce failure when missing."
            exit 0
          fi

          curl --fail-with-body --request GET "${COOLIFY_WEBHOOK}" \
            --header "Authorization: Bearer ${COOLIFY_TOKEN}"

          python3 .github/scripts/verify_coolify_deployment.py \
            --webhook "${COOLIFY_WEBHOOK}" \
            --token "${COOLIFY_TOKEN}" \
            --app-uuid "${APP_UUID}" \
            --commit "${GITHUB_SHA}" \
            --initial-wait 60 \
            --poll-interval 30 \
            --timeout 600
